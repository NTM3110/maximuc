import{w as C,g as h}from"./dWGBaOqy.js";const d=[];for(let t=0;t<256;++t)d.push((t+256).toString(16).slice(1));function R(t,e=0){return(d[t[e+0]]+d[t[e+1]]+d[t[e+2]]+d[t[e+3]]+"-"+d[t[e+4]]+d[t[e+5]]+"-"+d[t[e+6]]+d[t[e+7]]+"-"+d[t[e+8]]+d[t[e+9]]+"-"+d[t[e+10]]+d[t[e+11]]+d[t[e+12]]+d[t[e+13]]+d[t[e+14]]+d[t[e+15]]).toLowerCase()}let v;const F=new Uint8Array(16);function A(){if(!v){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");v=crypto.getRandomValues.bind(crypto)}return v(F)}const L=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),P={randomUUID:L};function O(t,e,i){t=t||{};const n=t.random??t.rng?.()??A();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,R(n)}function E(t,e,i){return P.randomUUID&&!t?P.randomUUID():O(t)}const w="/rest",U="/rest/latest-value",M="maxicom-strings-config",j=12,f=C([]),$=C(!1),_=C(!1);Q(),q();function Q(){try{const t=localStorage.getItem(M);t&&f.set(JSON.parse(t))}catch(t){console.error("Error reading String config from localStorage",t),f.set([])}}function y(t){localStorage.setItem(M,JSON.stringify(t))}async function q(t=!1){if(h(_)){await new Promise(e=>{const i=_.subscribe(n=>{n||(i(),e(null))})});return}_.set(!0);try{let e=[];const i=k(!1);if(t||i.length===0)try{e=(await J()).filter(o=>o>0).sort((o,g)=>o-g)}catch(a){console.warn("[Strings] Failed to get devices from OpenMUC, using cache indices:",a),e=i}else e=i;if(e.length===0){t&&(f.set([]),y([])),_.set(!1),$.set(!0);return}const n=h(f),r=new Map(n.map(a=>[a.stringIndex,a])),s=t?new Set(e):null,l=await Promise.all(e.map(async a=>{try{const o=await N(a);return{index:a,dto:o,source:"latest-value"}}catch{return{index:a,dto:null,source:"latest-value"}}})),u=l.filter(a=>!a.dto||!S(a.dto)).map(a=>a.index);u.length>0&&(await Promise.all(u.map(async o=>{try{const g=await B(o);return{index:o,dto:g,source:"openmuc"}}catch{return{index:o,dto:null,source:"openmuc"}}}))).forEach(o=>{const g=l.find(I=>I.index===o.index);g&&(g.dto=o.dto,g.source=o.source)});const c=new Map;l.forEach(({index:a,dto:o})=>{if(s&&!s.has(a))return;const g=r.get(a);if(o&&S(o)){const I=`str${a}`,x=V(o,I,a,g);c.set(a,x)}else g&&!t&&c.set(a,g)}),t||r.forEach((a,o)=>{c.has(o)||c.set(o,a)});const m=Array.from(c.values()).sort((a,o)=>a.stringIndex-o.stringIndex);f.set(m),y(m)}finally{_.set(!1),$.set(!0)}}async function H(t){try{let e=await N(t);if(!e||!S(e))try{e=await B(t)}catch{}if(e&&S(e)){const i=`str${t}`,r=h(f).find(l=>l.stringIndex===t),s=V(e,i,t,r);return f.update(l=>{const u=l.findIndex(c=>c.stringIndex===t);if(u>=0){const c=[...l];return c[u]=s,y(c),c}else{const c=[...l,s].sort((m,a)=>m.stringIndex-a.stringIndex);return y(c),c}}),s}}catch(e){console.error(`Failed to load string ${t}`,e)}return null}function k(t=!1){const e=h(f).map(i=>i.stringIndex);if(t){const i=Array.from({length:j},(r,s)=>s+1);return Array.from(new Set([...e,...i])).filter(r=>r>0).sort((r,s)=>r-s)}return e.filter(i=>i>0).sort((i,n)=>i-n)}async function N(t){const e=new URLSearchParams({stringID:t.toString()}),n=await(await fetch(`${U}/string?${e}`)).json();return n?.success?n.data:null}async function B(t){const e=[`str${t}_string_name`,`str${t}_cell_qty`,`str${t}_cell_brand`,`str${t}_cell_model`,`str${t}_Cnominal`,`str${t}_Vnominal`],i=await Promise.all(e.map(async r=>{try{const l=await(await fetch(`${w}/channels/${r}`)).json();return{channel:r,value:l?.record?.value}}catch{return{channel:r,value:null}}})),n={};return i.forEach(({channel:r,value:s})=>{s!=null&&(r.includes("string_name")?n.stringName=String(s):r.includes("cell_qty")?n.cellQty=Number(s):r.includes("cell_brand")?n.cellBrand=String(s):r.includes("cell_model")?n.cellModel=String(s):r.includes("Cnominal")?n.cNominal=Number(s):r.includes("Vcutoff")?n.vCutoff=Number(s):r.includes("Vfloat")?n.vFloat=Number(s):r.includes("serial_port_id")&&(n.serialPortId=String(s)))}),S(n)?n:null}function S(t){return t?!!(t.stringName&&t.stringName.trim().length>0||t.cellBrand&&t.cellBrand.trim().length>0||t.cellModel&&t.cellModel.trim().length>0||typeof t.cellQty=="number"||typeof t.cNominal=="number"||typeof t.vCutoff=="number"||typeof t.vFloat=="number"):!1}function V(t,e,i,n){const r=(s,l)=>{if(s==null)return l??0;const u=Number(s);return Number.isFinite(u)?u:l??0};return{id:n?.id||E(),stringIndex:i,stringName:t.stringName?.trim()||n?.stringName||e,cellQty:r(t.cellQty,n?.cellQty),cellBrand:t.cellBrand??n?.cellBrand??"",cellModel:t.cellModel??n?.cellModel??"",ratedCapacity:r(t.cNominal,n?.ratedCapacity),cutoffVoltage:r(t.vCutoff,n?.cutoffVoltage),floatVoltage:r(t.vFloat,n?.floatVoltage),serialPortId:t.serialPortId??n?.serialPortId??""}}async function J(){const e=await(await fetch(`${w}/devices`)).json(),i=[],n=/^str(\d+)_(modbus|virtual)$/;return e.devices?.forEach(r=>{const s=r.match(n);if(s){const l=parseInt(s[1],10);!isNaN(l)&&!i.includes(l)&&i.push(l)}}),i.sort((r,s)=>r-s)}async function K(t,e){const r=h(f).reduce((u,c)=>Math.max(u,c.stringIndex),0)+1,s={...t,id:E(),stringIndex:r};if(await G(r))throw new Error(`String ${r} already exists on OpenMUC. Please reload the page.`);return await T(r,t,e),f.update(u=>{const c=[...u,s];return y(c),c}),$.set(!0),setTimeout(async()=>{const u=await N(r);if(u&&S(u)){const c=V(u,`str${r}`,r,s);f.update(m=>{const a=m.findIndex(o=>o.id===s.id);if(a>=0){const o=[...m];return o[a]=c,y(o),o}return m})}},2e3),s}async function G(t){try{const[e,i]=await Promise.all([fetch(`${w}/devices_v2/str${t}_modbus`).then(n=>n.ok),fetch(`${w}/devices_v2/str${t}_virtual`).then(n=>n.ok)]);return e||i}catch{return!1}}async function T(t,e,i){const n={stringIndex:t,cellQty:e.cellQty,stringName:e.stringName,cellBrand:e.cellBrand,cellModel:e.cellModel,ratedCapacity:e.ratedCapacity,cutoffVoltage:e.cutoffVoltage,floatVoltage:e.floatVoltage,serialPortId:e.serialPortId,portConfig:{port:i.port,baudRate:i.baudRate,dataBits:i.dataBits,stopBits:i.stopBits,parity:i.parity}};await fetch(`${w}/string`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),await new Promise(s=>setTimeout(s,1e3));const r=[p(`str${t}_string_name`,e.stringName),p(`str${t}_cell_qty`,e.cellQty),p(`str${t}_cell_brand`,e.cellBrand),p(`str${t}_cell_model`,e.cellModel),p(`str${t}_Cnominal`,e.ratedCapacity),p(`str${t}_Vcutoff`,e.cutoffVoltage),p(`str${t}_Vfloat`,e.floatVoltage),p(`str${t}_serial_port_id`,e.serialPortId)];await Promise.all(r)}async function p(t,e){const i={record:{flag:"VALID",value:e}};await fetch(`${w}/channels/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})}async function X(t){const e=h(f).find(n=>n.id===t);if(!e)throw new Error("String Config not found");const i=e.stringIndex;await b(`/devices_v2/str${i}_modbus`),await b(`/devices_v2/str${i}_virtual`);try{await fetch(`${U}/delete-string?stringId=${i}`,{method:"POST"})}catch(n){console.warn("Failed to delete metadata",n)}f.update(n=>{const r=n.filter(s=>s.id!==t);return y(r),r}),$.set(!0)}async function b(t){try{await fetch(`${w}${t}`,{method:"DELETE"})}catch{}}async function Y(t,e,i){const n=h(f).find(s=>s.id===t);if(!n)throw new Error("String Config not found");const r=n.stringIndex;await b(`/devices_v2/str${r}_modbus`),await b(`/devices_v2/str${r}_virtual`),await T(r,e,i),f.update(s=>{const l={...n,...e},u=s.map(c=>c.id===t?l:c);return y(u),u})}export{K as a,H as b,$ as c,X as d,_ as i,q as l,f as s,Y as u};
